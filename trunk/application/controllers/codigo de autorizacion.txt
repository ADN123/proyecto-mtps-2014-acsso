/*
	*	Nombre: autorizar_requisicion
	*	Objetivo: Aprobar y asignar los vales a entregar a la oficina, o en su defecto rechazar la peticion
	*	Hecha por: Jhonatan
	*	Modificada por: Jhonatan
	*	Última Modificación: 7/06/2014
	*	Observaciones: Ninguna.
	*
	function autorizar_requisicion($estado_transaccion=NULL)
	{
		$data=$this->seguridad_model->consultar_permiso($this->session->userdata('id_usuario'),81); /*Verificacion de permiso para crear requisiciones*
		$id_seccion=$this->transporte_model->consultar_seccion_usuario($this->session->userdata('nr'));	
		//$data['id_permiso']=$permiso;
		if($data['id_permiso']!=NULL) {
			switch($data['id_permiso']) { /*Busqueda de informacion a mostrar en la pantalla segun el nivel del usuario logueado*
				case 1:
				case 2://seccion
					$data['datos']=$this->vales_model->consultar_requisiciones($id_seccion['id_seccion'], 2);
					break;
				case 3://administrador
					$data['datos']=$this->vales_model->consultar_requisiciones(NULL,2);					
					break;
				case 4: //departamental					
					if($this->vales_model->is_departamental($id_seccion['id_seccion'])){// fuera de san salvador
						$data['datos']=$this->vales_model->consultar_requisiciones($id_seccion['id_seccion'], 2);
					}
					else{//san salvador
						$data['datos']=$this->vales_model->consultar_requisiciones_san_salvador(2);
					}
					break;
			}
			$data['estado_transaccion']=$estado_transaccion;
			//print_r($data);
			pantalla("vales/autorizacion",$data);	
		}
		else {
			echo 'No tiene permisos para acceder';
		}
	}

	/*
	*	Nombre: dialogo_autorizacion
	*	Objetivo: 	cargar el cuadro de dialogo mediante ajax en la pantalla de autorizacion
	*	Hecha por: Jhonatan
	*	Modificada por: Jhonatan
	*	Última Modificación: 7/06/2014
	*	Observaciones: Ninguna.
	*
	function dialogo_autorizacion($id)
	{
		$data=$this->seguridad_model->consultar_permiso($this->session->userdata('id_usuario'),81);
		if(isset($data['id_permiso'])&& $data['id_permiso']>=2 ) {
			$id_seccion=$this->transporte_model->consultar_seccion_usuario($this->session->userdata('nr'));
			$datos['d']=$this->vales_model->info_requisicion($id);
			$datos['f']=$this->vales_model->info_requisicion_vehiculos($id);
			$datos['id']=$id;
			$this->load->view('vales/dialogo_autorizacion',$datos);
		}
		else {
			echo 'No tiene permisos para acceder';
		}
	}


	/*
	*	Nombre: guardar_autorizacion
	*	Objetivo: 	Guardar la informacion o respuesta del usuario en visto bueno
	*	Hecha por: Jhonatan
	*	Modificada por: Jhonatan
	*	Última Modificación: 8/06/2014
	*	Observaciones: Utilizo el arreglo POST para faciclitar la transferencia de datos al modelo
	*
	function guardar_autorizacion()
	{
		$data=$this->seguridad_model->consultar_permiso($this->session->userdata('id_usuario'),81);
		$id_empleado=$this->vales_model->get_id_empleado($this->session->userdata('nr')); 
		$_POST['id_usuario']=$this->session->userdata('id_usuario');
		$_POST['id_empleado']=$id_empleado;

		if($data['id_permiso']!=NULL) {
			$this->db->trans_start();
			$this->vales_model->guardar_autorizacion($_POST);
			$this->db->trans_complete();
			$tr=($this->db->trans_status()===FALSE)?0:1;
			ir_a('index.php/vales/autorizar_requisicion/'.$tr);		
		}else{
			echo 'No tiene permisos para acceder';
		}
	}
